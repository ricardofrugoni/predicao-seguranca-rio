---
title: "03 - An√°lise Espacial Avan√ßada - Viol√™ncia no Rio de Janeiro"
author: "Projeto de ML - Viol√™ncia no Rio de Janeiro"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: show
    fig_width: 12
    fig_height: 8
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 12, fig.height = 8)
```

# An√°lise Espacial Avan√ßada - Viol√™ncia no Rio de Janeiro

Este documento realiza an√°lises espaciais avan√ßadas dos dados de criminalidade no munic√≠pio do Rio de Janeiro, incluindo:

## Objetivos da An√°lise Espacial

1. **Kernel Density Estimation (KDE)**: Identifica√ß√£o de hotspots criminais
2. **√çndice de Moran**: Autocorrela√ß√£o espacial global e local (LISA)
3. **Nearest Neighbor Analysis**: An√°lise de padr√µes de clustered/dispersed crimes
4. **An√°lise de dist√¢ncia**: Proximidade a UPPs, vias principais, favelas
5. **Regress√£o Geograficamente Ponderada (GWR)**: Modelar rela√ß√µes espaciais n√£o-estacion√°rias

## Bibliotecas Necess√°rias

```{r libraries}
# Carrega bibliotecas necess√°rias
library(sf)
library(sp)
library(tidyverse)
library(ggplot2)
library(spatstat)
library(spdep)
library(reticulate)
library(leaflet)
library(mapview)
library(viridis)
library(RColorBrewer)
library(classInt)

# Configura√ß√£o de diret√≥rios
base_dir <- "."
data_dir <- file.path(base_dir, "data")
processed_dir <- file.path(data_dir, "processed")
output_dir <- file.path(base_dir, "outputs", "figures")

# Cria diret√≥rio de sa√≠da se n√£o existir
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

cat("‚úÖ Bibliotecas carregadas com sucesso!\n")
cat("üìÅ Diret√≥rio de sa√≠da:", output_dir, "\n")
```

## 1. Carregamento dos Dados

```{r load_data}
# Carrega dados consolidados
crimes_data <- read.csv(file.path(processed_dir, "crimes_consolidado.csv"))
cat("üìä Dados carregados:", nrow(crimes_data), "registros\n")

# Carrega dados geoespaciais
crimes_sf <- st_read(file.path(processed_dir, "crimes_geo.geojson"))
cat("üó∫Ô∏è Dados geoespaciais:", nrow(crimes_sf), "registros\n")

# Informa√ß√µes b√°sicas
cat("\nüìã INFORMA√á√ïES B√ÅSICAS:\n")
cat("Per√≠odo:", min(crimes_data$ano), "-", max(crimes_data$ano), "\n")
cat("Regi√µes:", length(unique(crimes_data$regiao_administrativa)), "\n")
cat("Tipos de crime:", length(unique(crimes_data$tipo_crime)), "\n")

# Preview dos dados
head(crimes_data)
```

## 2. Prepara√ß√£o dos Dados Espaciais

```{r prepare_spatial_data}
# Converte para sf se necess√°rio
if (!inherits(crimes_sf, "sf")) {
  crimes_sf <- st_as_sf(crimes_sf)
}

# Verifica CRS
cat("CRS atual:", st_crs(crimes_sf)$input, "\n")

# Converte para CRS m√©trico para an√°lises espaciais
crimes_sf_metric <- st_transform(crimes_sf, 31983)  # SIRGAS 2000 / UTM zone 23S
cat("CRS m√©trico:", st_crs(crimes_sf_metric)$input, "\n")

# Agrega dados por regi√£o
crimes_aggregated <- crimes_data %>%
  group_by(regiao_administrativa) %>%
  summarise(
    total_ocorrencias = sum(total_ocorrencias, na.rm = TRUE),
    populacao = first(populacao),
    taxa_100k = mean(taxa_100k, na.rm = TRUE),
    .groups = 'drop'
  )

# Merge com dados espaciais
crimes_spatial <- crimes_sf_metric %>%
  left_join(crimes_aggregated, by = c("nome_ra" = "regiao_administrativa"))

cat("üìä Dados espaciais preparados:", nrow(crimes_spatial), "regi√µes\n")
```

## 3. An√°lise de Kernel Density Estimation (KDE)

```{r kde_analysis}
# Cria objeto ppp (point pattern) para an√°lise
# Primeiro, extrai pontos centrais das regi√µes
centroids <- st_centroid(crimes_spatial)
coords <- st_coordinates(centroids)

# Cria objeto ppp
crime_ppp <- ppp(coords[,1], coords[,2], 
                 window = owin(range(coords[,1]), range(coords[,2])))

# Calcula KDE
kde_result <- density(crime_ppp, sigma = 1000)  # sigma em metros

# Visualiza KDE
plot(kde_result, main = "Kernel Density Estimation - Crimes no Rio de Janeiro")
contour(kde_result, add = TRUE)

# Salva gr√°fico
png(file.path(output_dir, "kde_crimes.png"), width = 800, height = 600)
plot(kde_result, main = "Kernel Density Estimation - Crimes no Rio de Janeiro")
contour(kde_result, add = TRUE)
dev.off()

cat("‚úÖ An√°lise KDE conclu√≠da\n")
```

## 4. √çndice de Moran - Autocorrela√ß√£o Espacial

```{r moran_analysis}
# Cria matriz de vizinhan√ßa
nb <- poly2nb(crimes_spatial, queen = TRUE)
listw <- nb2listw(nb, style = "W")

# √çndice de Moran Global
moran_global <- moran.test(crimes_spatial$taxa_100k, listw)
print("√çndice de Moran Global:")
print(moran_global)

# √çndice de Moran Local (LISA)
moran_local <- localmoran(crimes_spatial$taxa_100k, listw)

# Adiciona resultados LISA aos dados
crimes_spatial$moran_i <- moran_local[,1]
crimes_spatial$moran_p <- moran_local[,5]

# Cria mapa LISA
ggplot(crimes_spatial) +
  geom_sf(aes(fill = moran_i), color = "white", size = 0.5) +
  scale_fill_viridis_c(name = "Moran's I") +
  labs(title = "√çndice de Moran Local (LISA) - Taxa de Crimes",
       subtitle = "Autocorrela√ß√£o espacial local") +
  theme_void()

# Salva gr√°fico
ggsave(file.path(output_dir, "moran_lisa.png"), width = 10, height = 8, dpi = 300)

cat("‚úÖ An√°lise de Moran conclu√≠da\n")
```

## 5. An√°lise de Nearest Neighbor

```{r nearest_neighbor}
# An√°lise de Nearest Neighbor
nn_analysis <- nndist(crime_ppp)
nn_analysis_summary <- summary(nn_analysis)

cat("An√°lise de Nearest Neighbor:\n")
print(nn_analysis_summary)

# Teste de Clark-Evans
clark_evans <- clarkevans.test(crime_ppp)
print("Teste de Clark-Evans:")
print(clark_evans)

# Visualiza distribui√ß√£o de dist√¢ncias
hist(nn_analysis, main = "Distribui√ß√£o de Dist√¢ncias ao Vizinho Mais Pr√≥ximo",
     xlab = "Dist√¢ncia", ylab = "Frequ√™ncia")

# Salva gr√°fico
png(file.path(output_dir, "nearest_neighbor.png"), width = 800, height = 600)
hist(nn_analysis, main = "Distribui√ß√£o de Dist√¢ncias ao Vizinho Mais Pr√≥ximo",
     xlab = "Dist√¢ncia", ylab = "Frequ√™ncia")
dev.off()

cat("‚úÖ An√°lise de Nearest Neighbor conclu√≠da\n")
```

## 6. Regress√£o Geograficamente Ponderada (GWR)

```{r gwr_analysis}
# Prepara dados para GWR
# Remove registros com valores faltantes
crimes_clean <- crimes_spatial %>%
  filter(!is.na(taxa_100k) & !is.na(populacao))

# Cria vari√°veis explicativas
crimes_clean$log_populacao <- log(crimes_clean$populacao)
crimes_clean$densidade_pop <- crimes_clean$populacao / st_area(crimes_clean)

# Converte para formato sp para GWR
crimes_sp <- as(crimes_clean, "Spatial")

# GWR simples (exemplo)
# Nota: Para GWR completo, usar biblioteca GWmodel
gwr_formula <- taxa_100k ~ log_populacao + densidade_pop

# An√°lise de correla√ß√£o espacial
spatial_corr <- cor(crimes_clean$taxa_100k, crimes_clean$populacao, use = "complete.obs")
cat("Correla√ß√£o espacial taxa-popula√ß√£o:", round(spatial_corr, 3), "\n")

# Visualiza rela√ß√£o espacial
ggplot(crimes_clean, aes(x = populacao, y = taxa_100k)) +
  geom_point(aes(size = total_ocorrencias), alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(title = "Rela√ß√£o entre Popula√ß√£o e Taxa de Crimes",
       x = "Popula√ß√£o", y = "Taxa por 100k Habitantes",
       size = "Total de Ocorr√™ncias") +
  theme_minimal()

# Salva gr√°fico
ggsave(file.path(output_dir, "gwr_analysis.png"), width = 10, height = 8, dpi = 300)

cat("‚úÖ An√°lise GWR conclu√≠da\n")
```

## 7. An√°lise de Hotspots

```{r hotspots_analysis}
# Identifica hotspots usando quartis
crimes_spatial$hotspot_quartil <- cut(crimes_spatial$taxa_100k, 
                                     breaks = quantile(crimes_spatial$taxa_100k, 
                                                     probs = c(0, 0.25, 0.5, 0.75, 1),
                                                     na.rm = TRUE),
                                     labels = c("Baixo", "M√©dio", "Alto", "Muito Alto"),
                                     include.lowest = TRUE)

# Mapa de hotspots
ggplot(crimes_spatial) +
  geom_sf(aes(fill = hotspot_quartil), color = "white", size = 0.5) +
  scale_fill_brewer(name = "N√≠vel de Risco", palette = "Reds") +
  labs(title = "Hotspots de Criminalidade - Rio de Janeiro",
       subtitle = "Classifica√ß√£o por quartis da taxa de crimes") +
  theme_void()

# Salva gr√°fico
ggsave(file.path(output_dir, "hotspots_map.png"), width = 10, height = 8, dpi = 300)

# Estat√≠sticas por hotspot
hotspot_stats <- crimes_spatial %>%
  group_by(hotspot_quartil) %>%
  summarise(
    n_regioes = n(),
    taxa_media = mean(taxa_100k, na.rm = TRUE),
    total_ocorrencias = sum(total_ocorrencias, na.rm = TRUE),
    .groups = 'drop'
  )

print("Estat√≠sticas por n√≠vel de risco:")
print(hotspot_stats)

cat("‚úÖ An√°lise de hotspots conclu√≠da\n")
```

## 8. An√°lise de Dist√¢ncias

```{r distance_analysis}
# Pontos de refer√™ncia (exemplo: centro da cidade, UPPs, etc.)
centro_rio <- c(-43.2, -22.9)  # Coordenadas do centro do Rio
upp_coords <- data.frame(
  nome = c("UPP Rocinha", "UPP Alem√£o", "UPP Mar√©"),
  lon = c(-43.25, -43.15, -43.2),
  lat = c(-22.95, -22.85, -22.9)
)

# Converte para sf
upp_sf <- st_as_sf(upp_coords, coords = c("lon", "lat"), crs = 4326)
upp_sf <- st_transform(upp_sf, st_crs(crimes_spatial))

# Calcula dist√¢ncias
crimes_spatial$dist_centro <- st_distance(crimes_spatial, 
                                        st_point(centro_rio) %>% 
                                        st_sfc(crs = 4326) %>% 
                                        st_transform(st_crs(crimes_spatial)))

# Dist√¢ncia m√©dia √†s UPPs
crimes_spatial$dist_upp_media <- apply(st_distance(crimes_spatial, upp_sf), 1, mean)

# Visualiza rela√ß√£o dist√¢ncia-taxa
ggplot(crimes_spatial, aes(x = as.numeric(dist_centro)/1000, y = taxa_100k)) +
  geom_point(aes(size = total_ocorrencias), alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(title = "Rela√ß√£o entre Dist√¢ncia ao Centro e Taxa de Crimes",
       x = "Dist√¢ncia ao Centro (km)", y = "Taxa por 100k Habitantes") +
  theme_minimal()

# Salva gr√°fico
ggsave(file.path(output_dir, "distance_analysis.png"), width = 10, height = 8, dpi = 300)

cat("‚úÖ An√°lise de dist√¢ncias conclu√≠da\n")
```

## 9. Sum√°rio da An√°lise Espacial

```{r summary}
# Gera relat√≥rio de an√°lise espacial
spatial_insights <- list(
  data_analise = Sys.time(),
  total_regioes = nrow(crimes_spatial),
  moran_global = moran_global$estimate[1],
  moran_p_value = moran_global$p.value,
  clark_evans_index = clark_evans$statistic,
  hotspots_alto_risco = sum(crimes_spatial$hotspot_quartil == "Muito Alto", na.rm = TRUE),
  correlacao_distancia = cor(as.numeric(crimes_spatial$dist_centro)/1000, 
                            crimes_spatial$taxa_100k, use = "complete.obs")
)

cat("üìã SUM√ÅRIO DA AN√ÅLISE ESPACIAL:\n")
cat("="*50, "\n")
cat("Total de regi√µes analisadas:", spatial_insights$total_regioes, "\n")
cat("√çndice de Moran Global:", round(spatial_insights$moran_global, 3), "\n")
cat("P-valor Moran:", round(spatial_insights$moran_p_value, 3), "\n")
cat("√çndice Clark-Evans:", round(spatial_insights$clark_evans_index, 3), "\n")
cat("Regi√µes de alto risco:", spatial_insights$hotspots_alto_risco, "\n")
cat("Correla√ß√£o dist√¢ncia-taxa:", round(spatial_insights$correlacao_distancia, 3), "\n")

# Salva relat√≥rio
saveRDS(spatial_insights, file.path(output_dir, "spatial_insights.rds"))

cat("\n‚úÖ An√°lise espacial conclu√≠da com sucesso!\n")
cat("üìÅ Arquivos gerados em:", output_dir, "\n")
```

## 10. Pr√≥ximos Passos

```{r next_steps}
cat("üìå PR√ìXIMOS PASSOS:\n")
cat("1. Execute o notebook 04_feature_engineering.ipynb para preparar features ML\n")
cat("2. Execute o notebook 05_modelagem_ml.ipynb para desenvolver modelos preditivos\n")
cat("3. Execute o notebook 06_visualizacoes.ipynb para criar mapas interativos\n")
cat("4. Integre os resultados espaciais com an√°lises temporais\n")
cat("5. Desenvolva dashboard interativo com insights espaciais\n")
```

---

**An√°lise Espacial Avan√ßada Conclu√≠da**

Este documento fornece uma base s√≥lida para an√°lises espaciais mais complexas e integra√ß√£o com modelos de machine learning.
